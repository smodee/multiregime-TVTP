# multiregime-TVTP

**Multi-Regime Time-Varying Transition Probability Models**

A comprehensive R implementation of regime-switching models with time-varying transition probabilities, supporting arbitrary K-regime models with multiple transition dynamics.

## Overview

This repository implements several regime-switching models where the transition probabilities between states can vary over time based on different dynamics:

- **Constant Model**: Fixed transition probabilities (baseline model)
- **TVP Model**: Autoregressive dynamics where transitions depend on lagged observations
- **Exogenous Model**: Transitions driven by external variables
- **GAS Model**: Score-driven dynamics based on the predictive likelihood (Generalized Autoregressive Score)

The key innovation is the extension from 2-regime to K-regime models while maintaining numerical stability and computational efficiency.

## Package Structure

```
multiregimeTVTP/
│
├── R/                             # All R source files
│   ├── model_constant.R           # Constant transition probability model
│   ├── model_TVP.R                # Time-varying transition probability (autoregressive)
│   ├── model_exogenous.R          # Exogenous-driven transition model
│   ├── model_GAS.R                # Generalized Autoregressive Score model
│   ├── utility_functions.R        # Basic utilities (logit, logistic, etc.)
│   ├── transition_helpers.R       # Transition matrix operations
│   ├── parameter_transforms.R     # Parameter extraction and transformation
│   ├── score_functions.R          # GAS score calculations and scaling
│   ├── parallel_utils.R           # Parallel processing utilities
│   ├── analysis_functions.R       # Post-estimation analysis
│   └── multiregimeTVTP-package.R  # Package documentation
│
├── man/                           # Generated documentation (roxygen2)
├── tests/testthat/                # Unit tests (testthat framework)
├── DESCRIPTION                    # Package metadata
├── NAMESPACE                      # Exports (generated by roxygen2)
└── LICENSE                        # MIT License
```

## Installation

### From GitHub

```r
# Install devtools if you don't have it
install.packages("devtools")

# Install multiregimeTVTP
devtools::install_github("smodee/multiregime-TVTP")
```

### Load the package

```r
library(multiregimeTVTP)
```

Dependencies (`statmod`, `future`, `future.apply`) are installed automatically.

## Quick Start

### Basic Usage Example

```r
library(multiregimeTVTP)

# Estimate a 2-regime constant model
y <- rnorm(1000)  # Replace with your data
result <- estimate_constant_model(y, K = 2, n_starts = 5)

# View results
print(result$parameters)
print(result$diagnostics)
```

### Model Comparison

```r
# Compare different models on the same data
comparison <- compare_tvtp_models(
  y = y,
  K = 3,
  models = c("Constant", "TVP", "GAS"),
  verbose = TRUE
)

# View comparison results
print(comparison$summary)
print(comparison$rankings)
```

## Model Details

### 1. Constant Model
Fixed transition probabilities that don't change over time.

**Parameters:** `mu` (K), `sigma2` (K), `trans_prob` (K*(K-1))

**Functions:**
- `dataConstCD()` - Generate data
- `Rfiltering_Const()` - Filter/likelihood calculation
- `estimate_constant_model()` - Parameter estimation

### 2. TVP Model (Autoregressive)
Transition probabilities depend on lagged observations:
```
f[t+1] = omega + A * y[t]
p[t+1] = logistic(f[t+1])
```

**Parameters:** `mu` (K), `sigma2` (K), `init_trans` (K*(K-1)), `A` (K*(K-1))

**Functions:**
- `dataTVPCD()` - Generate data
- `Rfiltering_TVP()` - Filter/likelihood calculation
- `estimate_tvp_model()` - Parameter estimation

### 3. Exogenous Model
Transition probabilities driven by external variables:
```
f[t+1] = omega + A * X_exo[t]
p[t+1] = logistic(f[t+1])
```

**Parameters:** `mu` (K), `sigma2` (K), `init_trans` (K*(K-1)), `A` (K*(K-1))

**Functions:**
- `dataTVPXExoCD()` - Generate data
- `Rfiltering_TVPXExo()` - Filter/likelihood calculation
- `estimate_exo_model()` - Parameter estimation

### 4. GAS Model (Score-Driven)
Transition probabilities evolve based on the score of the predictive likelihood:
```
f[t+1] = omega + A * s[t] + B * (f[t] - omega)
p[t+1] = logistic(f[t+1])
```

**Parameters:** `mu` (K), `sigma2` (K), `init_trans` (K*(K-1)), `A` (K*(K-1)), `B` (K*(K-1))

**Functions:**
- `dataGASCD()` - Generate data
- `Rfiltering_GAS()` - Filter/likelihood calculation
- `estimate_gas_model()` - Parameter estimation

## Advanced Features

### Multi-Start Optimization
All estimation functions support multiple starting points for robust optimization:

```r
estimate <- estimate_tvp_model(
  y = y,
  K = 3,
  n_starts = 10,  # Use 10 random starting points
  parallel = TRUE, # Enable parallel processing
  cores = 4        # Use 4 CPU cores
)
```

### Custom Parameter Bounds
Specify bounds for parameter estimation:

```r
estimate <- estimate_gas_model(
  y = y,
  K = 3,
  lower_bounds = list(mu = -10, sigma2 = 0.01, A = 0, B = 0),
  upper_bounds = list(mu = 10, sigma2 = 10, A = 1, B = 1)
)
```

### Simulation Studies
Run comprehensive simulation studies:

```r
# GAS model simulation study
results <- run_gas_simulation_study(
  num_repetitions = 100,
  sample_sizes = c(500, 1000, 2000),
  K = 3,
  seed = 123,
  output_dir = "results/gas_simulation"
)

# Plot results
plot_gas_simulation_results(results, output_file = "results/gas_plots.pdf")
```

## Helper Functions

### Transition Matrix Operations
- `transition_matrix()` - Convert vector to transition matrix
- `convert_to_valid_probs()` - Ensure valid stochastic matrix
- `validate_transition_matrix()` - Check matrix validity

### Parameter Transformations
- `transform_parameters()` - Transform to unconstrained space
- `untransform_parameters()` - Transform back to natural space
- `mean_from_par()`, `sigma2_from_par()`, etc. - Extract components

### Score Functions (GAS)
- `calculate_gas_score()` - Compute scaled score
- `setup_gauss_hermite_quadrature()` - Setup numerical integration
- `apply_moore_penrose_scaling()` - Apply score scaling

## Performance Considerations

### Numerical Stability
- All models use log-likelihood calculations to avoid underflow
- Transition probabilities are constrained to valid ranges
- Variance parameters are log-transformed during optimization

### Computational Efficiency
- Parallel processing for multi-start optimization
- Vectorized operations where possible
- Efficient matrix operations for transition calculations

### Scaling to Large K
- Memory usage scales as O(K²) for transition matrices
- Computation time scales approximately as O(K³N) for filtering
- Recommended maximum K ≈ 10 for practical applications

## Testing

The package uses `testthat` for unit testing:

```r
devtools::test()
```

## Known Issues and Limitations

### Current Limitations
1. **GAS Model Scaling**: The Moore-Penrose pseudo-inverse scaling for GAS models can be numerically unstable. The simple scaling method is recommended for production use.

2. **Large K Performance**: For K > 10, optimization becomes challenging due to the high-dimensional parameter space.

3. **Identification Issues**: Some parameter combinations may lead to label switching or weak identification.

### Work in Progress
- [ ] Implement comprehensive unit tests
- [ ] Add diagnostic tools for model selection
- [ ] Implement regime prediction functionality
- [ ] Add support for multivariate observations
- [ ] Develop interactive visualization tools

## Contributing

Contributions are welcome! Please:
1. Fork the repository
2. Create a feature branch
3. Add tests for new functionality
4. Submit a pull request with a clear description

## Citation

If you use this code in your research, please cite:

**GAS methodology:**
```bibtex
@article{bazzi2017time,
  title={Time-varying transition probabilities for Markov regime switching models},
  author={Bazzi, M. and Blasques, F. and Koopman, S.J. and Lucas, A.},
  journal={Journal of Time Series Analysis},
  volume={38},
  number={3},
  pages={458--478},
  year={2017}
}
```

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

Copyright (c) 2025 Samuel Modée

## Contact

Samuel Modée - Repository maintainer

For questions, issues, or contributions, please open an issue on GitHub.

## Acknowledgments

This implementation incorporates ideas from Bazzi et al. (2017) for score-driven dynamics.
